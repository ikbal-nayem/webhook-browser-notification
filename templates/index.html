{% extends "base.html" %} {% block header_script %}
<script type="text/javascript" src="/static/register-service-worker.js"></script>
{% endblock %} {% block content %}
<div class="mt-5">
	<h3 class="text-center text-primary">GEMS Deployment Status</h3>

	<form id="subscription-form">
		<div id="service-block" class="row my-3">
			<div class="col-md-4">
				<div class="card">
					<div class="card-header">
						<h5 class="card-title text-success">Stage</h5>
					</div>
					<div class="card-body">
						{% for s in services %}
						<div class="form-check">
							<input class="form-check-input" type="checkbox" name="stage_{{s}}" id="stage_{{s}}" />
							<label class="form-check-label" for="stage_{{s}}"> {{s}} </label>
						</div>
						{% endfor %}
					</div>
				</div>
			</div>
			<div class="col-md-4">
				<div class="card">
					<div class="card-header">
						<h5 class="card-title text-success">Training</h5>
					</div>
					<div class="card-body">
						{% for s in services %}
						<div class="form-check">
							<input class="form-check-input" type="checkbox" name="training_{{s}}" id="training_{{s}}" />
							<label class="form-check-label" for="training_{{s}}"> {{s}} </label>
						</div>
						{% endfor %}
					</div>
				</div>
			</div>
			<div class="col-md-4">
				<div class="card">
					<div class="card-header">
						<h5 class="card-title text-success">Production</h5>
					</div>
					<div class="card-body">
						{% for s in services %}
						<div class="form-check">
							<input class="form-check-input" type="checkbox" name="production_{{s}}" id="production_{{s}}" />
							<label class="form-check-label" for="production_{{s}}"> {{s}} </label>
						</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>

		<div class="text-center">
			<button type="submit" class="btn btn-primary">Subscribe</button>
		</div>
	</form>
	{% endblock %} {% block script %}
	<script type="text/javascript">
		// let hasServiceWorker = false;
		if (navigator.serviceWorker) {
			navigator.serviceWorker.getRegistrations().then((registration) => {
				if (registration?.length > 0) {
					console.log('Service worker is Ready');
					// hasServiceWorker = true;
				} else {
					console.log('Service worker is not registered');
					registerServiceWorker(
						'/static/service-worker.js',
						"{{config['VAPID_PUBLIC_KEY']}}",
						'/service-worker/subscription',
						'{{user.email}}'
					);
				}
			});
		}
		const us = JSON.parse('{{user_subscriptions|tojson}}');

		const sForm = document.getElementById('subscription-form');
		sForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			e.stopPropagation();
			Array.from(sForm.elements).forEach((formElement) => (formElement.disabled = true));
			const elements = Array.from(e.currentTarget);
			const data = elements.reduce((acc, el) => {
				el.checked && acc.push(el.name);
				return acc;
			}, []);

			fetch('/substribe', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ data, prev_subscriptions: us }),
			})
				.then((resp) => {
					console.log(resp);
				})
				.finally(() => Array.from(sForm.elements).forEach((formElement) => (formElement.disabled = false)));
		});
	</script>
	{% endblock %}
</div>
